# AI Social 平台热度系统完整实现清单

> 基于 HOTNESS_OPTIMIZATION.md 的详细实现指南
> 创建时间：2025-08-18
> 最后更新：2025-08-18

## 📋 项目概述

本清单基于之前设计的 AI Social 平台热度优化方案，提供了从基础架构到完整部署的详细实施步骤。热度系统将支持实时热度计算、防刷保护、趋势推荐等核心功能。

## 🎯 实施目标

### 核心指标
- **实时性**: 用户互动后 < 100ms 内更新热度
- **准确性**: 防刷误报率 < 1%
- **性能**: 1000 并发请求，响应时间 < 200ms
- **扩展性**: 支持未来 10 倍流量增长

### 功能特性
- [x] 基础热度计算
- [x] 防刷保护机制
- [ ] 实时趋势推荐
- [ ] 前端可视化
- [ ] 性能监控
- [ ] A/B 测试框架

## 🔧 技术栈与架构

### 后端架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Cloudflare    │    │     Redis       │    │      D1         │
│    Workers      │◄───┤   (Upstash)     │◄───┤   (SQLite)      │
│                 │    │                 │    │                 │
│ HotnessService  │    │ hot_rank:zset   │    │ artworks:table  │
│ AntiSpam        │    │ artwork:*:hash  │    │ users:table     │
│ Metrics         │    │ user:*:stats    │    │ interactions    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 前端架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Next.js 14    │    │   React Hooks   │    │   Components    │
│   App Router    │◄───┤   useHotness    │◄───┤ HotnessIndicator│
│                 │    │   useTrending   │    │ TrendingPage    │
│ SWR Cache       │    │   useRealtime   │    │ FeedFilter      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 📊 详细实施清单

### 1️⃣ 核心服务实现 (Phase 1)

#### 1.1 HotnessService 核心类
- [x] 基础热度计算逻辑
- [x] 时间衰减算法
- [x] 质量权重因子
- [ ] 用户声誉计算
- [ ] 地理位置权重

**具体实现检查点：**
```typescript
// 检查点：时间衰减算法
const decay = Math.pow(0.8, days) * Math.pow(0.95, hours);
```

#### 1.2 Redis 数据结构初始化
- [x] 全局热度排行榜 (hot_rank)
- [x] 作品热度详情 (artwork:{id}:hot)
- [x] 用户行为记录 (user:{id}:actions)
- [ ] 趋势数据缓存 (trending:{timeframe})
- [ ] 防刷记录 (rate_limit:*)

**Redis 键名规范：**
```
hot_rank                 # 全局热度排行榜 (zset)
artwork:{id}:hot         # 作品热度详情 (hash)
user:{id}:actions        # 用户行为记录 (hash)
trending:1h              # 1小时趋势 (zset)
trending:24h             # 24小时趋势 (zset)
rate_limit:{user}:{action} # 防刷记录 (string, TTL 1h)
```

#### 1.3 防刷保护机制
- [x] 基础限频 (每小时限制)
- [x] 机器人行为检测
- [ ] IP 级别限制
- [ ] 设备指纹识别
- [ ] 行为模式分析

**防刷规则表：**
| 操作类型 | 每小时限制 | 每日限制 | 检测维度 |
|----------|------------|----------|----------|
| 点赞     | 10 次      | 50 次    | 用户+IP  |
| 收藏     | 5 次       | 20 次    | 用户+设备|
| 评论     | 20 次      | 100 次   | 用户+内容|
| 浏览     | 50 次      | 200 次   | IP+指纹  |

### 2️⃣ API 端点实现 (Phase 2)

#### 2.1 热度查询 API
- [ ] `GET /api/hotness/trending` - 热门作品
- [ ] `GET /api/hotness/rising` - 上升趋势
- [ ] `GET /api/hotness/viral` - 病毒传播
- [ ] `GET /api/hotness/:id` - 作品详情
- [ ] `GET /api/hotness/debug/:id` - 调试信息

**API 参数规范：**
```typescript
interface HotnessQueryParams {
  limit?: number;      // 返回数量 (1-100)
  time?: string;       // 时间窗口 (1h, 6h, 24h, 7d)
  category?: string;   // 作品分类
  userId?: string;     // 用户ID (个性化)
}
```

#### 2.2 实时更新端点
- [ ] `POST /api/artworks/:id/like` - 点赞并更新热度
- [ ] `DELETE /api/artworks/:id/like` - 取消点赞
- [ ] `POST /api/artworks/:id/favorite` - 收藏
- [ ] `DELETE /api/artworks/:id/favorite` - 取消收藏
- [ ] `POST /api/artworks/:id/view` - 浏览记录

### 3️⃣ 前端组件实现 (Phase 3)

#### 3.1 热度展示组件
- [ ] HotnessIndicator 基础组件
- [ ] 热度趋势图表
- [ ] 排行榜组件
- [ ] 筛选器组件

**组件属性规范：**
```typescript
interface HotnessIndicatorProps {
  score: number;           // 热度分数
  rank?: number;           // 排名
  trend?: 'up' | 'down' | 'stable'; // 趋势
  size?: 'sm' | 'md' | 'lg'; // 尺寸
  showIcon?: boolean;      // 是否显示图标
  animated?: boolean;      // 是否动画
}
```

#### 3.2 页面实现
- [ ] 热门推荐页面 (`/trending`)
- [ ] 个人热度统计 (`/stats`)
- [ ] 管理后台热度配置
- [ ] 移动端适配

#### 3.3 实时更新机制
- [ ] WebSocket 实时推送
- [ ] SWR 缓存策略
- [ ] 乐观更新处理
- [ ] 错误边界处理

### 4️⃣ 性能优化 (Phase 4)

#### 4.1 缓存策略
- [ ] L1: 内存缓存 (1分钟)
- [ ] L2: Redis 缓存 (5分钟)
- [ ] L3: 数据库查询
- [ ] 缓存预热机制

#### 4.2 批量处理
- [ ] 批量热度更新
- [ ] 异步队列处理
- [ ] 定时任务优化
- [ ] 数据分片存储

#### 4.3 监控指标
- [ ] 响应时间监控 (P95 < 200ms)
- [ ] 错误率监控 (< 0.1%)
- [ ] 缓存命中率 (> 80%)
- [ ] 防刷触发次数

### 5️⃣ 测试与部署 (Phase 5)

#### 5.1 测试策略
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试 (API + 数据库)
- [ ] 压力测试 (1000并发)
- [ ] 防刷测试 (模拟攻击)

#### 5.2 部署检查
- [ ] 环境变量配置
- [ ] Redis 连接测试
- [ ] D1 数据库迁移
- [ ] CDN 配置优化

#### 5.3 监控告警
- [ ] 错误告警 (Slack/邮件)
- [ ] 性能告警 (P95 > 500ms)
- [ ] 业务告警 (异常热度)
- [ ] 容量告警 (Redis 内存 > 80%)

## 🔍 每日检查清单

### 开发日检查
- [ ] 今日任务是否完成
- [ ] 代码是否通过测试
- [ ] API 文档是否更新
- [ ] 性能指标是否达标

### 测试日检查
- [ ] 单元测试是否通过
- [ ] 集成测试是否通过
- [ ] 压力测试是否通过
- [ ] 安全测试是否通过

### 部署日检查
- [ ] 环境配置是否正确
- [ ] 监控是否配置完成
- [ ] 回滚方案是否准备
- [ ] 用户通知是否发送

## 📈 进度追踪

### 当前进度 (2025-08-18)
- **Phase 1**: 50% 完成
  - ✅ 基础架构搭建
  - ✅ 核心算法实现  
  - ✅ 类型错误修复
  - ⏳ 防刷机制完善
  - ⏳ 性能优化

- **Phase 2**: 0% 完成
  - ⏳ API 端点实现
  - ⏳ 文档完善
  - ⏳ 测试用例编写

- **Phase 3**: 0% 完成
  - ⏳ 前端组件开发
  - ⏳ 页面实现
  - ⏳ 实时更新

### 下一阶段重点
1. **完善防刷机制** - 添加 IP 限制和设备指纹识别
2. **实现热点推荐 API** - 创建 /trending 和 /rising 端点
3. **前端组件开发** - 开始 HotnessIndicator 和 TrendingPage

## 🚨 风险与注意事项

### 技术风险
- **Redis 内存压力**: 需要设置合理的 TTL 和清理策略
- **并发更新冲突**: 需要实现分布式锁机制
- **数据一致性**: 需要定期同步 Redis 和 D1 数据

### 业务风险
- **防刷误伤**: 需要设置合理的阈值和人工审核机制
- **热点聚集**: 需要防止马太效应过于明显
- **新作品曝光**: 需要设置新作品保护期机制

### 性能风险
- **计算复杂度**: 热度计算需要优化算法复杂度
- **缓存失效**: 需要设置合理的缓存更新策略
- **数据库压力**: 需要优化查询和索引设计

## 📞 紧急联系
- **技术负责人**: [填写姓名]
- **产品负责人**: [填写姓名]
- **运维负责人**: [填写姓名]
- **紧急热线**: [填写电话]

---

**更新频率**: 每日更新进度，每周总结回顾  
**文档版本**: v1.0  
**最后更新**: 2025-08-18  
**下次更新**: 2025-08-19