M3 大任务：Clerk 鉴权 + D1/Upstash/R2 真接入 + 生产化验证（Claude 可直接执行）

---

### 执行提示词
请严格按“任务条目/完成标准/自测脚本”执行；保持现有代码风格；只改标注位置；边改边自测。

---

## 目标
- 启用真实鉴权：前端注入 Clerk JWT，Workers 端验证；DEV 与 PROD 双通道。
- 接入持久化：D1（查询/写入）、Upstash Redis（计数/集合）、R2（上传/URL），替换内存回退。
- 生产化质量：错误码一致、日志规范、环境与部署脚本完整，联调通过。

---

## 任务条目
1) 鉴权（Clerk）
- 前端：在 `authFetch` 中优先使用 `@clerk/nextjs` 的 `auth().getToken()`；SSR 下通过 `cookies` 获取；无 token 时降级 `DEV_JWT`。
- 后端：`middlewares/auth.ts` 使用 `@clerk/backend` `verifyToken`，校验 `issuer/jwksUrl/secretKey`；`DEV_MODE=1` 时放行。

2) D1 迁移与读写
- 新增 `apps/worker-api/migrations/001_init.sql`（如未存在）并附本地 apply 命令说明。
- `services/d1.ts`：移除 fallback 分支后的重复查询路径，保留 `try/catch`，出错记录日志；
  - `getArtwork/listFeed/listUserArtworks/publishArtwork/createArtwork` 全走 D1；
  - 新增 likes/favorites 表访问（如需要）。

3) Upstash Redis 接入
- `services/redis.ts`：将 `execute` 中的 REST 路径与返回解析对齐 Upstash 文档；
- 点赞计数使用 `INCRBY/GET`；收藏集合使用 `SADD/SREM/SMEMBERS`；
- 所有路由中读取/写入 Redis 替代内存；DEV 下可强制使用内存（开关）。

4) R2 上传
- `services/r2.ts`：增加签名/公开 URL 生成；
- `POST /api/artworks/upload`：接收 `formData`，写 R2，写 D1 草稿，返回 `id/url/status`；
- 前端：在 `CreateArtworkModal` 增加真实上传路径（保留演示模式开关）。

5) 返回体与错误处理
- 所有接口统一 camelCase 字段；错误码统一 `{ code, message }`，HTTP 状态对应 4xx/5xx；
- 增加基本日志（请求路径、耗时、错误）。

6) 环境与部署
- `.dev.vars.example`、`apps/web/.env.local.example`：分别列出 DEV/PROD 必需变量；
- README 追加：本地迁移、启动与 Pages/Workers 部署步骤。

---

## 完成标准
- 前端：`NEXT_PUBLIC_USE_MOCK=0` 时所有页面使用 `/api/*`；点赞/收藏/发布/上传可用；
- 后端：鉴权生效（DEV 放行、PROD 校验）；D1/Redis/R2 路径实际可用；
- 类型检查无误；手动自测接口与页面通过；
- 日志与错误码规范一致。

---

## 自测脚本
```bash
# 后端（DEV）
npm --workspace apps/worker-api run dev
iwr -UseBasicParsing http://127.0.0.1:8787/api/health | % Content
iwr -UseBasicParsing http://127.0.0.1:8787/api/feed   | % Content

# 前端（DEV）
npm --workspace apps/web run dev
# 浏览 /feed /user/demo-user /artwork/a1/cyber-cat

# 上传（示例 cURL；如需在 Windows PowerShell，用 Invoke-WebRequest 的 -Form）
curl -F "file=@/path/to/image.png" -F "title=demo" http://127.0.0.1:8787/api/artworks/upload
```


