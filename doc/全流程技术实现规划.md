全流程技术实现规划（基于架构蓝图 + 原型图 + UI 规范）

---

## 0. 范围说明

本规划覆盖从零到一的完整实现路径：技术栈选择、依赖清单、前后端代码结构、接口契约、缓存/存储/异步任务方案、SEO/性能、环境变量、CI/CD 与部署。严格对齐以下文档（已根据当前仓库状态修正）：
- `doc/AI社区全流程架构蓝图.md`
- `doc/原型图.md`
- `doc/前端UI设计规划.md`

---

## 1. 技术栈与托管

- 运行与托管（当前状态 → 目标）：
  - 前端 SSR：Next.js 14 App Router 运行于 Cloudflare Pages（使用 `@cloudflare/next-on-pages` 适配）。
  - 后端 API：Cloudflare Workers（`wrangler` 管理），与前端同域/子路径部署（如 `/api/*`）。【最小实现已落地：artworks/users/feed/detail 路由、like/favorite/publish、health/redis ping；DEV 鉴权通行；详情接口修复；错误中间件与参数校验就绪；非本人仅返回 published；/upload 已打通并写入 D1；R2 公网 URL 已接入】
  - 静态资产：由 Pages 托管，图片/视频原文件与缩略图存于 R2。【原图已接入；缩略图生成待接入】
  - 任务调度：Workers Cron Triggers。【wrangler 已配置 cron，占位可用；业务任务未实现】

- 基础服务（目标，当前进度）：
  - 鉴权：Clerk（前端 SDK + Workers 后端校验 JWT）。【DEV_MODE=1 自动通行；生产需关闭 DEV 并启用 Clerk 校验】
  - 数据库：Cloudflare D1（`users`, `artworks`, `artworks_like`, `artworks_favorite`）。【绑定已配置并可查询；本地含测试数据；`artworks` 增加 `thumb_url`、`slug` 字段（迁移已提供）】
  - 缓存：Upstash Redis（HTTP API），Key 规范见蓝图。【已接入 REST 数组命令格式；DEV 在未配置 Upstash 时内存回退；实现 Feed/用户列表缓存 TTL（默认 10 分钟）与按需失效】
  - 对象存储：Cloudflare R2（`/artworks/original/:uuid`、`/artworks/thumb/:uuid`）。【上传封装已接入，支持 `R2_PUBLIC_UPLOAD_BASE`/`R2_PUBLIC_AFTER_BASE` 公网 URL；缩略图与权限后续完善】
  - 图片处理：Workers Image Resizing（或 Cloudflare Images）。【未接入】
  - AI 生成：第三方推理服务 + Workers 编排。【未接入】

- 前端 UI（当前状态）：
  - Tailwind CSS + CSS 变量 + 设计 Token 已落地。
  - 组件库（按钮/卡片/Badge/Tabs/Header/Sidebar/Toast/Skeleton）已落地。
  - 数据请求：客户端使用 `swr`；`NEXT_PUBLIC_USE_MOCK=0` 时默认走 `/api/*`；`authFetch` 支持 DEV JWT 回退与相对 `/api/*` 自动重写；端到端回归脚本已提供（PowerShell）。
  - 图标：`lucide-react`；动效：暂未集成。

---

## 2. 代码仓库与文件结构（Monorepo 推荐）

```text
.
├─ apps/
│  ├─ web/                         # Next.js (Cloudflare Pages, SSR)
│  │  ├─ app/                      # App Router
│  │  │  ├─ (marketing)/
│  │  │  │  ├─ page.tsx            # /  营销落地页
│  │  │  │  └─ features/page.tsx   # /features 功能页
│  │  │  ├─ feed/page.tsx          # /feed
│  │  │  ├─ user/[username]/page.tsx
│  │  │  ├─ artwork/[id]/[slug]/page.tsx
│  │  │  └─ api/edge-proxy/route.ts # 可选：前端边缘代理（如需）
│  │  ├─ components/               # UI 组件（按钮/卡片/Tabs/Toast等）
│  │  ├─ styles/                    # 全局样式、CSS 变量定义
│  │  ├─ lib/                       # http 客户端、seo、utils
│  │  ├─ hooks/                     # useQuery/useMutation 封装
│  │  ├─ public/                    # 静态资源
│  │  ├─ tailwind.config.ts
│  │  └─ next.config.ts
│  │
│  └─ worker-api/                  # Cloudflare Workers (Hono)【已创建（基础骨架）】
│     ├─ src/
│     │  ├─ index.ts               # 入口，注册路由
│     │  ├─ middlewares/auth.ts    # Clerk JWT 校验
│     │  ├─ routers/
│     │  │  ├─ artworks.ts         # 生成/上传/发布/点赞/收藏/获取详情
│     │  │  ├─ users.ts            # 获取用户作品/收藏
│     │  │  └─ feed.ts             # Feed 获取
│     │  ├─ services/
│     │  │  ├─ ai.ts               # AI 生成编排（占位）
│     │  │  ├─ r2.ts               # R2 封装（公网 URL 支持）
│     │  │  ├─ d1.ts               # D1 查询封装
│     │  │  └─ redis.ts            # Upstash Redis 客户端
│     │  ├─ utils/
│     │  │  ├─ response.ts         # 统一响应/错误格式
│     │  │  └─ slug.ts             # slug 工具
│     │  └─ types.ts               # 公共类型定义
│     ├─ migrations/               # D1 SQL（含 thumb_url/slug 迁移）
│     ├─ wrangler.toml             # 绑定 D1/R2/Redis/Secrets/Cron
│     └─ package.json
│
├─ packages/
│  ├─ ui/                          # 共用 UI（可选）
│  └─ config/                      # ESLint/TSConfig/Prettier（可选）
│
├─ infra/                          # IaC 或部署脚本（可选）
└─ README.md
```

---

## 3. 依赖清单（关键）

### 前端（apps/web）
- 已安装：`next@14`、`react@18`、`react-dom@18`、`tailwindcss@3`、`postcss`、`autoprefixer`、`swr`、`clsx`、`tailwind-merge`、`lucide-react`
- 待安装（部署/鉴权/SEO/校验）：`@cloudflare/next-on-pages`、`@clerk/nextjs`、`next-seo`、`zod`

### 后端（apps/worker-api）【已创建（骨架）】
- `hono`、`wrangler`、`@clerk/backend`、`@upstash/redis`、`uuid`、`slugify`、`zod`

---

## 4. 数据库与存储

### D1 表结构（与蓝图一致，结合迁移更新）

```sql
-- users
CREATE TABLE IF NOT EXISTS users (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  profile_pic TEXT
);

-- artworks（已增加 thumb_url 与 slug）
CREATE TABLE IF NOT EXISTS artworks (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  title TEXT,
  url TEXT NOT NULL,
  thumb_url TEXT,
  slug TEXT,
  status TEXT NOT NULL CHECK (status IN ('draft','published')),
  created_at INTEGER NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- likes
CREATE TABLE IF NOT EXISTS artworks_like (
  user_id TEXT NOT NULL,
  artwork_id TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  PRIMARY KEY (user_id, artwork_id)
);

-- favorites
CREATE TABLE IF NOT EXISTS artworks_favorite (
  user_id TEXT NOT NULL,
  artwork_id TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  PRIMARY KEY (user_id, artwork_id)
);
```

迁移说明：
- `003_add_thumb_url.sql`：为 `artworks` 表新增 `thumb_url` 并用 `url` 回填初值。
- `004_add_slug.sql`：为 `artworks` 表新增 `slug` 并以标题生成回填（生成规则见 `services/d1.ts`）。

### R2 目录
- `/artworks/original/:uuid`
- `/artworks/thumb/:uuid`

### Redis Key 规范
- `user:{user_id}:artworks`（list）
- `user:{user_id}:favorites`（set）
- `hot_rank`（zset）
- `feed_queue`（list）
- `artwork:{id}:likes`（int/score）

实现差异：前端以 `thumbUrl`、`originalUrl` 字段渲染；后端已返回对应 R2 公网访问 URL（通过 `R2_PUBLIC_*` 拼接）。

---

## 5. API 契约（请求/响应）

> 路径与动作严格对应蓝图。当前前端已实现以“直返数据”为主（不包 success 信封）；建议后端首版直返数据以加快联调，后续再统一 `{ success, data }`。

- `POST /api/auth/login`（前端由 Clerk 负责 OAuth，Workers 仅用于校验 JWT）

- `POST /api/artworks/generate`（需要 JWT）
  - Body：`{ prompt: string, file?: binary }`
  - 流程：AI 生成 → R2 上传原图 → D1 写入 `status:'draft'` → Redis 更新 `user:{id}:artworks`、`hot_rank`、`feed_queue`
  - Resp：`{ artwork_id, url, status: 'draft' }`

- `POST /api/artworks/upload`（需要 JWT）
  - Body：`{ file: binary, title: string }`
  - 流程同上（跳过 AI）；`thumbUrl` 初始与原图一致，后续由 Cron 生成后更新
  - Resp：`{ id, originalUrl, thumbUrl, status, title }`

- `POST /api/artworks/:id/publish`（需要 JWT）
  - 业务：`draft -> published`，写 D1；触发异步缩略图生成；刷新 Feed 缓存
  - Resp：`{ status: 'published', id }`

- `POST /api/artworks/:id/like`（需要 JWT）
  - D1 upsert + Redis `artwork:{id}:likes` 自增
  - Resp：`{ likeCount: number, isLiked: true }`

- `DELETE /api/artworks/:id/like`（需要 JWT）
  - D1 删除 + Redis `artwork:{id}:likes` 自减
  - Resp：`{ likeCount: number, isLiked: false }`

- `POST /api/artworks/:id/favorite`（需要 JWT）
  - D1 upsert + Redis `user:{id}:favorites` 更新
  - Resp：`{ isFavorite: true }`

- `DELETE /api/artworks/:id/favorite`（需要 JWT）
  - D1 删除 + Redis `user:{id}:favorites` 更新
  - Resp：`{ isFavorite: false }`

- `GET /api/users/:id/artworks`（需要 JWT）
  - Owner 视角：返回 `draft + published`；他人只返回 `published`
  - 优先读 Redis `user:{id}:artworks`，未命中查询 D1 并回填

- `GET /api/users/:id/favorites`（需要 JWT）
  - 读取 D1 `artworks_favorite` + Redis set，返回作品列表

- `GET /api/feed`（需要 JWT）
  - 读取缓存未命中则查询 D1，回填缓存
  - Resp：`ArtworkListItem[]`

- `GET /api/artworks/:id`（需要 JWT）
  - 返回作品与作者信息，用于详情页 + SEO meta
  - Resp：`ArtworkDetail`

统一错误码建议：`AUTH_REQUIRED`、`BAD_REQUEST`、`NOT_FOUND`、`RATE_LIMITED`、`INTERNAL_ERROR`。

---

## 6. 后端实现要点（Workers + Hono）

- 中间件：
  - `authMiddleware`：读取 `Authorization: Bearer <JWT>`，用 `@clerk/backend` 验证；将 `ctx.var.userId` 注入路由；DEV 仅当 `DEV_MODE==='1'` 时跳过校验并注入 `dev-user`。
  - `errorMiddleware`：统一捕获异常并返回标准错误体，并处理 404。
  - `loggerMiddleware`：记录请求耗时与状态码。
  - `validation`：采用 `zod` 校验 path/query；`limit` 兼容 string/number 并转为 bounded number。

- 服务封装：
  - `d1.ts`：参数化查询、结果映射、slug 生成、发布/点赞/收藏写入；提供一致性检查所需方法。
  - `r2.ts`：`putObject/getObject/getPublicUrl`，支持配置化公网 URL（`R2_PUBLIC_*`）；签名 URL 可选。
  - `redis.ts`：Upstash REST 客户端；在 DEV 未配置 Upstash 时回退内存；提供 Feed/用户列表 TTL 缓存与失效。
  - `ai.ts`：统一 AI 生成接口（占位）。

- 缩略图生成（Cron/任务）：
  - 扫描 `feed_queue` 或最近 `published` 作品 → 读取原图 → Image Resizing → 写入 `/artworks/thumb/:uuid` → 更新相关缓存与 `thumb_url`。

- 性能：
  - 路由使用 `Hono`，避免过多中间层；
  - 合理设置 Redis TTL（如 5–15 分钟），并在写入时同步失效；
  - `likeCount` 同步写入 Redis + D1；中长期可加事件式回写与一致性校验（脚本已提供一致性检查与修复）。

---

## 7. 前端实现要点（Next.js 14）

- 路由与页面（当前状态）：
  - `/` 与 `/features`：已上线，含 SEO 元信息；
  - `/feed`、`/user/:username`、`/artwork/:id/:slug`：已实现，默认走 `/api/*` 实时数据；`NEXT_PUBLIC_USE_MOCK=1` 时读取 `public/mocks`；
  - 可见性：`/users/:id/artworks` 对非本人仅返回 `published`（已实现）。
  - 详情页元数据：已静态配置示例，后续由 `GET /api/artworks/:id` 动态生成。

- 组件与样式：
  - 全局注入 CSS 变量（品牌色/中性色/阴影/半径/间距）。
  - Tailwind 挂钩变量，见 UI 文档的 `tailwind.config.js` 片段。
  - 公共组件：`Button/Card/Badge/Tabs/Header/Sidebar/ImageLazy/Toast/Skeleton`。

- 数据层：
  - RSC + `fetch`（SSR/SSG）当前可读取 `public/mocks`；客户端用 `swr` 做互动态（like/favorite/publish/feed/favorites hooks 已就绪）。
  - API 客户端封装：`authFetch` 已有，将在接入 Clerk 后自动注入 JWT。

- 无障碍与国际化：
  - Focus Ring、`aria-label`、语义标签；
  - i18n 可用 `next-intl`（可选，后续扩展）。

---

## 8. 环境变量与绑定

### Workers（`wrangler.toml`）（已存在，建议按环境区分配置）
```toml
name = "ai-social-api"
main = "src/index.ts"
compatibility_date = "2024-06-01"

[vars]
# 本地建议通过 .dev.vars 注入 DEV_MODE（仅限本地）；生产/预发不设置 DEV_MODE
# 生产环境：通过 wrangler secret 配置下列敏感变量
# CLERK_SECRET_KEY 由 `wrangler secret put` 注入
# UPSTASH_REDIS_REST_URL / UPSTASH_REDIS_REST_TOKEN 由 `wrangler secret put` 注入
# R2_PUBLIC_UPLOAD_BASE / R2_PUBLIC_AFTER_BASE 可按需配置为公网访问域名
CLERK_ISSUER = "..."
AI_ENDPOINT = "..."
R2_PUBLIC_UPLOAD_BASE = "https://..."
R2_PUBLIC_AFTER_BASE = "https://..."

[[d1_databases]]
binding = "DB"   # D1 binding 名
database_name = "ai-social-db"
database_id = "..."

[[r2_buckets]]
binding = "R2_UPLOAD"
bucket_name = "ai-social-upload"

[[r2_buckets]]
binding = "R2_AFTER"
bucket_name = "ai-social-after"

[triggers]
crons = ["*/15 * * * *"]
```

### Pages（Next.js）
- `NEXT_PUBLIC_SITE_URL`
- `NEXT_PUBLIC_USE_MOCK`
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`（待接入）
- `CLERK_SECRET_KEY`（待接入）
- `NEXT_PUBLIC_API_BASE_URL`（指向 Workers 域名或子路径 `/api`）

### Upstash Redis（生产必需）
- `UPSTASH_REDIS_REST_URL`
- `UPSTASH_REDIS_REST_TOKEN`

---

## 9. SEO 与性能

- SSR 首屏：营销页与详情页必须 SSR，Feed/用户页可 SSR + 懒加载。
- 图片：`<img loading="lazy">` 或 Next Image；缩略图优先 WebP/AVIF。
- 预取与缓存：`<link rel="preconnect">` 到 API 与 R2；API 响应设置 `Cache-Control`（短 TTL + ETag）。
- 元数据：`generateMetadata` 动态注入 `og:title/description/image`；路由结构匹配 `/artwork/:id/:slug`。
  - 现状：已配置基础 metadata；当 `NEXT_PUBLIC_USE_MOCK=0` 时 Feed/用户页/详情页均走 `/api/*` 实时数据；缩略图当前使用原图占位，待 Cron 生成后切换为真实 `thumbUrl`。

---

## 10. 开发与运行脚本（Monorepo）

```bash
# 安装（当前 monorepo 使用 npm workspaces）
npm i

# 本地开发（前端）
npm --workspace apps/web run dev

# 本地开发（Workers API）
npm --workspace apps/worker-api run dev

# 构建（前端）
npm --workspace apps/web run build

# 构建（Workers）【未创建】
# npm --workspace apps/worker-api run build
```

---

## 11. CI/CD（GitHub Actions 示意）

流水线：Lint → Test → Build → 部署 Workers → 部署 Pages。

关键步骤：
- 使用 `cloudflare/wrangler-action` 部署 Workers。
- 使用 `cloudflare/pages-action` 部署 Next.js（`npx @cloudflare/next-on-pages` 预构建）。
- 注入 Secrets：Clerk、Upstash、D1/R2 绑定。

---

## 12. 风险与边界（更新）

- 图像缩略图：Workers 环境下的图片处理需评估包体与冷启动，优先使用 Cloudflare Image Resizing 或外部服务。
- R2 访问：若开启私有读，需要签名 URL 或通过 Workers 代理读取。
- 热点数据一致性：Redis 与 D1 的最终一致，确保写入路径包含失效策略；关键计数可定时回写（脚本已提供一致性检查与修复）。
- 费用与配额：AI 生成/存储/流量需预算与告警。
  现状：Workers 最小版已连通（artworks/users/feed/detail/like/favorite/publish/upload）；详情修复；错误中间件/参数校验/可见性与 D1 一致性已补齐（like/favorite 同步写 D1 + Redis）；Upstash REST 已对接并实现 TTL/失效；返回体短期采用直返/精简对象；R2 公网 URL 与上传已就绪，缩略图与缓存策略优化待做；建议下一阶段统一响应格式与错误码。

---

## 13. 里程碑

1) M1 可用最小集（当前进度约 85%）：
   - [完成] 前端页面与 UI 组件、样式体系；Hooks（like/favorite/publish/feed/favorites/detail）。
   - [完成] Workers 最小链路：artworks/users/feed/detail/like/favorite/publish/upload 路由，服务封装（D1/Redis/R2）、Secrets 配置、DEV 鉴权。
   - [完成] 前端 SSR/RSC 已切到 `/api/*`（保留 mocks fallback）；`authFetch` 支持相对路径与 DEV JWT。
   - [进行中] D1/Upstash 真接入与缓存一致性（已接入、持续调优 TTL 与失效策略）。
   - [待办] Clerk 校验（前后端联通）、缩略图生成链路（Cron/Resizing）、响应 envelope 与错误码规范化、日志结构化。

2) M2 完整体验：
   - [待办] 国际化、占位图/骨架屏优化、Toast/错误边界、移动端适配、缓存策略调优。

3) M3 增强：
   - [待办] 通知、图片审核、统计面板、内容推荐强化。

---

## 14. 附：最小示例片段

### Workers 路由注册（Hono）
```ts
import { Hono } from 'hono'
import { authMiddleware } from './middlewares/auth'
import artworks from './routers/artworks'
import users from './routers/users'
import feed from './routers/feed'

const app = new Hono<{ Bindings: Env }>()
app.use('/api/*', authMiddleware)
app.route('/api/artworks', artworks)
app.route('/api/users', users)
app.route('/api/feed', feed)
export default app
```

### Next.js 渐变标题与网格背景（样式）
```tsx
export function HeroTitle({ children }: { children: React.ReactNode }) {
  return (
    <h1 className="text-5xl md:text-7xl font-extrabold leading-tight">
      <span className="text-gradient">{children}</span>
    </h1>
  )
}
```

---

以上方案即可直接指导团队完成端到端落地，确保与架构蓝图、原型图与 UI 规范完全一致，并兼顾性能、可维护性与扩展性。


