全流程技术实现规划（基于架构蓝图 + 原型图 + UI 规范）

---

## 0. 范围说明

本规划覆盖从零到一的完整实现路径：技术栈选择、依赖清单、前后端代码结构、接口契约、缓存/存储/异步任务方案、SEO/性能、环境变量、CI/CD 与部署。严格对齐以下文档（已根据当前仓库状态修正）：
- `doc/AI社区全流程架构蓝图.md`
- `doc/原型图.md`
- `doc/前端UI设计规划.md`

---

## 1. 技术栈与托管

- 运行与托管（当前状态 → 目标）：
  - 前端 SSR：Next.js 14 App Router 运行于 Cloudflare Pages（使用 `@cloudflare/next-on-pages` 适配）。
  - 后端 API：Cloudflare Workers（`wrangler` 管理），与前端同域/子路径部署（如 `/api/*`）。【基础骨架已创建：`apps/worker-api`；已提供 `/api/health`、`/api/redis/ping`；业务路由未落地】
  - 静态资产：由 Pages 托管，图片/视频原文件与缩略图存于 R2。【未启动】
  - 任务调度：Workers Cron Triggers。【wrangler 已配置 cron，占位可用；业务任务未实现】

- 基础服务（目标，当前进度）：
  - 鉴权：Clerk（前端 SDK + Workers 后端校验 JWT）。【未接入】
  - 数据库：Cloudflare D1（`users`, `artworks`, `artworks_like`, `artworks_favorite`）。【wrangler 绑定已配置，占位 DB 名；查询读写未实现】
  - 缓存：Upstash Redis（HTTP API），Key 规范见蓝图。【Upstash REST URL 已配置，TOKEN 待通过 secret 注入；仅提供 `/api/redis/ping` 测试】
  - 对象存储：Cloudflare R2（`/artworks/original/:uuid`、`/artworks/thumb/:uuid`）。【wrangler 绑定已配置；读写封装未实现】
  - 图片处理：Workers Image Resizing（或 Cloudflare Images）。【未接入】
  - AI 生成：第三方推理服务 + Workers 编排。【未接入】

- 前端 UI（当前状态）：
  - Tailwind CSS + CSS 变量 + 设计 Token 已落地。
  - 组件库（按钮/卡片/Badge/Tabs/Header/Sidebar/Toast/Skeleton）已落地。
  - 数据请求：客户端使用 `swr`；RSC/SSR 目前从 `public/mocks` 读取，`authFetch` 已封装但 JWT 注入 TODO。
  - 图标：`lucide-react`；动效：暂未集成。

---

## 2. 代码仓库与文件结构（Monorepo 推荐）

```text
.
├─ apps/
│  ├─ web/                         # Next.js (Cloudflare Pages, SSR)
│  │  ├─ app/                      # App Router
│  │  │  ├─ (marketing)/
│  │  │  │  ├─ page.tsx            # /  营销落地页
│  │  │  │  └─ features/page.tsx   # /features 功能页
│  │  │  ├─ feed/page.tsx          # /feed
│  │  │  ├─ user/[username]/page.tsx
│  │  │  ├─ artwork/[id]/[slug]/page.tsx
│  │  │  └─ api/edge-proxy/route.ts # 可选：前端边缘代理（如需）
│  │  ├─ components/               # UI 组件（按钮/卡片/Tabs/Toast等）
│  │  ├─ styles/                    # 全局样式、CSS 变量定义
│  │  ├─ lib/                       # http 客户端、seo、utils
│  │  ├─ hooks/                     # useQuery/useMutation 封装
│  │  ├─ public/                    # 静态资源
│  │  ├─ tailwind.config.ts
│  │  └─ next.config.ts
│  │
│  └─ worker-api/                  # Cloudflare Workers (Hono)【已创建（基础骨架）】
│     ├─ src/
│     │  ├─ index.ts               # 入口，注册路由
│     │  ├─ middlewares/auth.ts    # Clerk JWT 校验
│     │  ├─ routers/
│     │  │  ├─ artworks.ts         # 生成/上传/发布/点赞/收藏/获取详情
│     │  │  ├─ users.ts            # 获取用户作品/收藏
│     │  │  └─ feed.ts             # Feed 获取
│     │  ├─ services/
│     │  │  ├─ ai.ts               # AI 生成编排
│     │  │  ├─ r2.ts               # R2 封装
│     │  │  ├─ d1.ts               # D1 查询封装
│     │  │  └─ redis.ts            # Upstash Redis 客户端
│     │  ├─ utils/
│     │  │  ├─ response.ts         # 统一响应/错误格式
│     │  │  └─ id.ts               # uuid/slug 工具
│     │  └─ types.ts               # 公共类型定义
│     ├─ migrations/               # D1 SQL
│     ├─ wrangler.toml             # 绑定 D1/R2/Redis/Secrets/Cron
│     └─ package.json
│
├─ packages/
│  ├─ ui/                          # 共用 UI（可选）
│  └─ config/                      # ESLint/TSConfig/Prettier（可选）
│
├─ infra/                          # IaC 或部署脚本（可选）
└─ README.md
```

---

## 3. 依赖清单（关键）

### 前端（apps/web）
- 已安装：`next@14`、`react@18`、`react-dom@18`、`tailwindcss@3`、`postcss`、`autoprefixer`、`swr`、`clsx`、`tailwind-merge`、`lucide-react`
- 待安装（部署/鉴权/SEO/校验）：`@cloudflare/next-on-pages`、`@clerk/nextjs`、`next-seo`、`zod`

### 后端（apps/worker-api）【已创建（骨架）】
- `hono`、`wrangler`、`@clerk/backend`、`@upstash/redis`、`uuid`、`slugify`、`zod`

---

## 4. 数据库与存储

### D1 表结构（与蓝图一致）

```sql
-- users
CREATE TABLE IF NOT EXISTS users (
  id TEXT PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  profile_pic TEXT
);

-- artworks
CREATE TABLE IF NOT EXISTS artworks (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  title TEXT,
  url TEXT NOT NULL,
  status TEXT NOT NULL CHECK (status IN ('draft','published')),
  created_at INTEGER NOT NULL,
  FOREIGN KEY (user_id) REFERENCES users(id)
);

-- likes
CREATE TABLE IF NOT EXISTS artworks_like (
  user_id TEXT NOT NULL,
  artwork_id TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  PRIMARY KEY (user_id, artwork_id)
);

-- favorites
CREATE TABLE IF NOT EXISTS artworks_favorite (
  user_id TEXT NOT NULL,
  artwork_id TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  PRIMARY KEY (user_id, artwork_id)
);
```

### R2 目录
- `/artworks/original/:uuid`
- `/artworks/thumb/:uuid`

### Redis Key 规范
- `user:{user_id}:artworks`（list）
- `user:{user_id}:favorites`（set）
- `hot_rank`（zset）
- `feed_queue`（list）
- `artwork:{id}:likes`（int/score）

实现差异：前端目前以 `thumbUrl`、`originalUrl` 字段渲染；后端返回需包含对应 R2 访问 URL。

---

## 5. API 契约（请求/响应）

> 路径与动作严格对应蓝图。当前前端已实现以“直返数据”为主（不包 success 信封）；建议后端首版直返数据以加快联调，后续再统一 `{ success, data }`。

- `POST /api/auth/login`（前端由 Clerk 负责 OAuth，Workers 仅用于校验 JWT）

- `POST /api/artworks/generate`（需要 JWT）
  - Body：`{ prompt: string, file?: binary }`
  - 流程：AI 生成 → R2 上传原图 → D1 写入 `status:'draft'` → Redis 更新 `user:{id}:artworks`、`hot_rank`、`feed_queue`
  - Resp：`{ artwork_id, url, status: 'draft' }`

- `POST /api/artworks/upload`（需要 JWT）
  - Body：`{ file: binary }`
  - 流程同上（跳过 AI）

- `POST /api/artworks/:id/publish`（需要 JWT）
  - 业务：`draft -> published`，写 D1；触发异步缩略图生成；刷新 Feed 缓存
  - Resp：`{ status: 'published' }`

- `POST /api/artworks/:id/like`（需要 JWT）
  - D1 upsert + Redis `artwork:{id}:likes` 自增
  - Resp：`{ likeCount: number, isLiked: true }`

- `DELETE /api/artworks/:id/like`（需要 JWT）
  - D1 删除 + Redis `artwork:{id}:likes` 自减
  - Resp：`{ likeCount: number, isLiked: false }`

- `POST /api/artworks/:id/favorite`（需要 JWT）
  - D1 upsert + Redis `user:{id}:favorites` 更新
  - Resp：`{ is_favorite: true }`

- `DELETE /api/artworks/:id/favorite`（需要 JWT）
  - D1 删除 + Redis `user:{id}:favorites` 更新
  - Resp：`{ is_favorite: false }`

- `GET /api/users/:id/artworks`（需要 JWT）
  - Owner 视角：返回 `draft + published`；他人只返回 `published`
  - 优先读 Redis `user:{id}:artworks`，未命中查询 D1 并回填

- `GET /api/users/:id/favorites`（需要 JWT）
  - 读取 D1 `artworks_favorite` + Redis set，返回作品列表

- `GET /api/feed`（需要 JWT）
  - 读取缓存未命中则查询 D1，回填缓存
  - Resp：`ArtworkListItem[]`

- `GET /api/artworks/:id`（需要 JWT）
  - 返回作品与作者信息，用于详情页 + SEO meta
  - Resp：`ArtworkDetail`

统一错误码建议：`AUTH_REQUIRED`、`BAD_REQUEST`、`NOT_FOUND`、`RATE_LIMITED`、`INTERNAL_ERROR`。

---

## 6. 后端实现要点（Workers + Hono）

- 中间件：
  - `authMiddleware`：读取 `Authorization: Bearer <JWT>`，用 `@clerk/backend` 验证；将 `ctx.var.userId` 注入路由。
  - `errorMiddleware`：统一捕获异常并返回标准错误体。

- 服务封装：
  - `d1.ts`：预编译 SQL、参数化查询、分页与映射器。
  - `r2.ts`：`putObject/getObject`，生成受限读取 URL（如需）。
  - `redis.ts`：Upstash REST 客户端，提供 `get/set/zadd/lpush/sadd` 等包装。
  - `ai.ts`：统一 AI 生成接口；可根据 `model` 切换供应商。

- 缩略图生成（Cron/任务）：
  - 扫描 `feed_queue` 或最近 `published` 作品 → 读取原图 → Image Resizing → 写入 `/artworks/thumb/:uuid` → 更新相关缓存。

- 性能：
  - 路由使用 `Hono`，避免过多中间层；
  - 合理设置 Redis TTL（如 5–15 分钟），并在写入时同步失效；
  - `like_count` 同步写入 Redis + 事件式回写 D1（按需）。

---

## 7. 前端实现要点（Next.js 14）

- 路由与页面（当前状态）：
  - `/` 与 `/features`：已上线，含 SEO 元信息；
  - `/feed`、`/user/:username`、`/artwork/:id/:slug`：已实现，当前从 `public/mocks` 读取，待与 `/api/*` 接口连通；
  - 详情页元数据：已静态配置示例，后续由 `GET /api/artworks/:id` 动态生成。

- 组件与样式：
  - 全局注入 CSS 变量（品牌色/中性色/阴影/半径/间距）。
  - Tailwind 挂钩变量，见 UI 文档的 `tailwind.config.js` 片段。
  - 公共组件：`Button/Card/Badge/Tabs/Header/Sidebar/ImageLazy/Toast/Skeleton`。

- 数据层：
  - RSC + `fetch`（SSR/SSG）当前读取 `public/mocks`；客户端用 `swr` 做互动态（like/favorite/publish hooks 已就绪）。
  - API 客户端封装：`authFetch` 已有，待接入 Clerk 将 JWT 注入请求头。

- 无障碍与国际化：
  - Focus Ring、`aria-label`、语义标签；
  - i18n 可用 `next-intl`（可选，后续扩展）。

---

## 8. 环境变量与绑定

### Workers（`wrangler.toml`）（当前仓库已存在并配置占位绑定）
```toml
name = "ai-social-api"
main = "src/index.ts"
compatibility_date = "2024-06-01"

[vars]
CLERK_ISSUER = "..."
AI_ENDPOINT = "..."

[[d1_databases]]
binding = "DB"   # D1 binding 名
database_name = "ai-social-db"
database_id = "..."

[[r2_buckets]]
binding = "BUCKET"
bucket_name = "ai-social"

[triggers]
crons = ["*/15 * * * *"]
```

### Pages（Next.js）
- `NEXT_PUBLIC_SITE_URL`（已使用于 SSR 读取 mocks）
- `NEXT_PUBLIC_USE_MOCK`（前端 `isMockEnabled` 切换 mocks）
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`（待接入）
- `CLERK_SECRET_KEY`（待接入）
- `API_BASE_URL`（指向 Workers 域名或子路径 `/api`，待接入）

### Upstash Redis
- `UPSTASH_REDIS_REST_URL`
- `UPSTASH_REDIS_REST_TOKEN`

---

## 9. SEO 与性能

- SSR 首屏：营销页与详情页必须 SSR，Feed/用户页可 SSR + 懒加载。
- 图片：`<img loading="lazy">` 或 Next Image；缩略图优先 WebP/AVIF。
- 预取与缓存：`<link rel="preconnect">` 到 API 与 R2；API 响应设置 `Cache-Control`（短 TTL + ETag）。
- 元数据：`generateMetadata` 动态注入 `og:title/description/image`；路由结构匹配 `/artwork/:id/:slug`。
 - 现状：已配置基础 metadata；Feed/用户页数据仍走 mocks。

---

## 10. 开发与运行脚本

```bash
# 安装（当前 monorepo 使用 npm workspaces）
npm i

# 本地开发（前端）
npm --workspace apps/web run dev

# 本地开发（Workers）【未创建】
# npm --workspace apps/worker-api run dev

# 构建（前端）
npm --workspace apps/web run build

# 构建（Workers）【未创建】
# npm --workspace apps/worker-api run build
```

---

## 11. CI/CD（GitHub Actions 示意）

流水线：Lint → Test → Build → 部署 Workers → 部署 Pages。

关键步骤：
- 使用 `cloudflare/wrangler-action` 部署 Workers。
- 使用 `cloudflare/pages-action` 部署 Next.js（`npx @cloudflare/next-on-pages` 预构建）。
- 注入 Secrets：Clerk、Upstash、D1/R2 绑定。

---

## 12. 风险与边界

- 图像缩略图：Workers 环境下的图片处理需评估包体与冷启动，优先使用 Cloudflare Image Resizing 或外部服务。
- R2 访问：若开启私有读，需要签名 URL 或通过 Workers 代理读取。
- 热点数据一致性：Redis 与 D1 的最终一致，确保写入路径包含失效策略；关键计数可定时回写。
- 费用与配额：AI 生成/存储/流量需预算与告警。
 现状：Workers 骨架与 wrangler 绑定已存在；业务路由/鉴权/D1-R2-Redis 封装未落地，短期以 mocks 驱动；建议尽快补齐 `artworks/users/feed` 路由与 Clerk 校验，打通最小链路。

---

## 13. 里程碑

1) M1 可用最小集（当前进度约 45%）：
   - [完成] 前端页面与 UI 组件、样式体系；SSR 基础与 mocks 数据；Hooks（like/favorite/publish/feed/favorites）。
   - [进行中] Workers 基础：Hono 应用、`/api/health`、`/api/redis/ping`、wrangler 绑定（D1/R2/Redis/Cron）。
   - [待办] 接入 Clerk、落地 Workers 业务 API（generate/upload/publish/like/favorite/feed/detail/users）与 D1/R2/Redis 封装；替换 mocks。
   - [待办] `authFetch` 注入 JWT、错误统一处理。

2) M2 完整体验：
   - [待办] 国际化、占位图/骨架屏优化、Toast/错误边界、移动端适配、缓存策略调优。

3) M3 增强：
   - [待办] 通知、图片审核、统计面板、内容推荐强化。

---

## 14. 附：最小示例片段

### Workers 路由注册（Hono）
```ts
import { Hono } from 'hono'
import { authMiddleware } from './middlewares/auth'
import artworks from './routers/artworks'
import users from './routers/users'
import feed from './routers/feed'

const app = new Hono<{ Bindings: Env }>()
app.use('/api/*', authMiddleware)
app.route('/api/artworks', artworks)
app.route('/api/users', users)
app.route('/api/feed', feed)
export default app
```

### Next.js 渐变标题与网格背景（样式）
```tsx
export function HeroTitle({ children }: { children: React.ReactNode }) {
  return (
    <h1 className="text-5xl md:text-7xl font-extrabold leading-tight">
      <span className="text-gradient">{children}</span>
    </h1>
  )
}
```

---

以上方案即可直接指导团队完成端到端落地，确保与架构蓝图、原型图与 UI 规范完全一致，并兼顾性能、可维护性与扩展性。


