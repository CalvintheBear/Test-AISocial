M2 大任务：前端全面切换 API + Clerk/D1/Upstash/R2 接入与验证（Claude 可直接执行）

---

### 给 Claude 的执行提示词
请严格按“任务条目/完成标准/自测脚本”执行，边改边自测；保持现有代码风格与目录；不要重构无关模块。若遇缺少外部服务，提供 DEV fallback 但优先真实接入。

---

## 任务目标
- 前端 SSR/RSC 与客户端全面切换到 Workers `/api/*`，移除 mocks 依赖。
- 接入 Clerk（前端注入 JWT + Workers 端校验），并在 DEV 下保留可运行能力。
- 接入 D1（最小查询/写入）、Upstash Redis（计数/集合）、R2（占位上传/读取 URL）。
- 完成完整联调与自测，满足文末“完成标准”。

---

## 任务条目（按序执行）

1) 前端切 API 与 JWT 注入
- 修改 `apps/web/lib/api/client.ts`：
  - 注入 Clerk 前端 JWT：使用 `@clerk/nextjs` 获取 token，设置 `Authorization: Bearer <JWT>`。
  - SSR/RSC 下读取 `process.env.NEXT_PUBLIC_USE_MOCK`，为 0 时一律请求 `/api/*`。
- 页面与数据：
  - `app/feed/page.tsx`、`app/user/[username]/page.tsx`、`app/artwork/[id]/[slug]/page.tsx` 从 `/api/*` 拉取数据。
  - 保留 `NEXT_PUBLIC_USE_MOCK=1` 时的 mocks 路径作为 fallback。

2) Workers 鉴权（Clerk 真接入）
- 新增 `@clerk/backend` 依赖；完善 `middlewares/auth.ts`：
  - 若 `DEV_MODE=1` 则通行（沿用 dev-user）；否则通过 Clerk JWKS 校验，解析 userId 注入。
  - 校验失败返回 `{ code: 'AUTH_REQUIRED' }` 401。

3) D1 读写接入
- 创建 `apps/worker-api/migrations/001_init.sql`（若不存在则保留）；新增查询与写入：
  - 替换 `services/d1.ts` 中内存存根：实现 `getArtwork/listFeed/listUserArtworks/publishArtwork` 的 D1 版本；
  - 在缺失数据时回退到内存存根（开发态）。

4) Upstash Redis 接入
- 替换 `services/redis.ts` 中计数与收藏集合为 Upstash REST 实现：
  - `incrLikes/getLikes` → 使用 `INCRBY` 或 REST 等价；
  - `addFavorite/removeFavorite/listFavorites` → 使用 `SADD/SREM/SMEMBERS`。
  - DEV 下保留内存存根。

5) R2 接入（最小）
- 新增 `services/r2.ts`：`putObject(file)` 与 `getPublicUrl(key)`（按桶名与 key 拼接）；
- 新增路由：`POST /api/artworks/upload`（接收 `formData` file，写 R2，写 D1 草稿，返回 url 与 id）。

6) 错误与一致性
- 统一后端响应字段命名（全部 camelCase，与前端类型一致）。
- 所有路由补充错误处理（404/401/500）。

7) 文档与环境
- 更新 `doc/AI社区全流程架构蓝图.md` 与 `doc/全流程技术实现规划.md` 的现状说明到“已全面切 API + 真接入完成”。
- 更新 `.dev.vars.example`、`apps/web/.env.local.example` 指引（保留 DEV 模式与真实接入两套）。

---

## 关键代码片段（只示意差异）

> 前端获取 JWT（示意）：`apps/web/lib/api/client.ts`
```ts
import { auth } from '@clerk/nextjs'

export async function authFetch<T=any>(input: RequestInfo, init: RequestInit = {}) {
  const { getToken } = auth()
  const token = await getToken()?.catch(() => undefined)
  const headers = {
    'Content-Type': 'application/json',
    ...(init.headers || {}),
    ...(token ? { Authorization: `Bearer ${token}` } : {}),
  }
  const res = await fetch(input, { ...init, headers, cache: 'no-store' })
  if (!res.ok) throw await res.json().catch(() => ({ message: res.statusText }))
  return res.json() as Promise<T>
}
```

> Workers 校验（示意）：`apps/worker-api/src/middlewares/auth.ts`
```ts
import { verifyToken } from '@clerk/backend'

export async function authMiddleware(c, next) {
  if (c.env?.DEV_MODE === '1') { (c as any).set('userId','dev-user'); return next() }
  const auth = c.req.header('authorization')
  if (!auth?.startsWith('Bearer ')) return c.json({ code: 'AUTH_REQUIRED' }, 401)
  const token = auth.slice('Bearer '.length)
  const payload = await verifyToken(token, { issuer: c.env.CLERK_ISSUER, jwksUrl: c.env.CLERK_JWKS_URL })
  ;(c as any).set('userId', payload.sub)
  return next()
}
```

---

## 完成标准
- 前端所有页面默认使用 `/api/*`，`NEXT_PUBLIC_USE_MOCK=1` 时可降级。
- 点赞/收藏/发布等操作端到端生效；收藏与 Feed 列表接口与前端类型一致。
- 鉴权：DEV 与 PROD 均可运行；PROD 必须校验 JWT。
- 持久化：D1 与 Upstash 至少完成最小读写；R2 完成最小上传并可在页面展示。
- 类型检查与基本自测全部通过。

---

## 自测脚本
```bash
# 后端（本地）
npm --workspace apps/worker-api run dev
curl -s http://127.0.0.1:8787/api/feed | jq
curl -s http://127.0.0.1:8787/api/artworks/a1 | jq

# 前端（本地）
npm --workspace apps/web run dev
# 浏览 /feed /artwork/a1/cyber-cat 与 /user/demo-user
```


