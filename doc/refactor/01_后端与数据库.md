# 01｜后端与数据库改造指南（ClaudeCode 任务）

> 提示词：
> 仅在以下范围改动：`apps/worker-api/**`、`apps/worker-api/migrations/**`、`doc/**`、`README.md`。
> 完成本章 5 项任务，逐项提交；每项完成后请本地 `wrangler dev` 验证、`wrangler deploy` 发布，并在 PR 中勾选 00_README 的对应条目。

---

## 任务 A：新增用户/作品时间与生成元数据字段

- 新增迁移：
  - users：`created_at INTEGER`、`updated_at INTEGER`
  - artworks：`updated_at INTEGER`、`published_at INTEGER`、`prompt TEXT`、`model TEXT`、`seed INTEGER`、`width INTEGER`、`height INTEGER`、`mime_type TEXT`
- 示例迁移（新增文件 `apps/worker-api/migrations/005_extend_fields.sql`）：
```sql
ALTER TABLE users ADD COLUMN created_at INTEGER;
ALTER TABLE users ADD COLUMN updated_at INTEGER;

ALTER TABLE artworks ADD COLUMN updated_at INTEGER;
ALTER TABLE artworks ADD COLUMN published_at INTEGER;
ALTER TABLE artworks ADD COLUMN prompt TEXT;
ALTER TABLE artworks ADD COLUMN model TEXT;
ALTER TABLE artworks ADD COLUMN seed INTEGER;
ALTER TABLE artworks ADD COLUMN width INTEGER;
ALTER TABLE artworks ADD COLUMN height INTEGER;
ALTER TABLE artworks ADD COLUMN mime_type TEXT;
```
- 执行：
```bash
cd apps/worker-api
wrangler d1 migrations apply test-d1 --remote
```

---

## 任务 B：发布接口写入发布时间与更新时间

- 文件：`apps/worker-api/src/services/d1.ts`
- 目标：在 `publishArtwork(id)` 中设置 `published_at=now, updated_at=now`。
- 示例：
```ts
async publishArtwork(id: string) {
  const now = Date.now()
  await this.db.prepare(`UPDATE artworks SET status='published', published_at=?, updated_at=? WHERE id=?`) 
    .bind(now, now, id).run()
  return this.getArtwork(id)
}
```

---

## 任务 C：上传接口补充文件元信息与更新时间

- 文件：`apps/worker-api/src/routers/artworks.ts`
- 目标：在 `/upload` 中读取 `file.type`，可选读取宽高（若前端能提供），写入 `mime_type/width/height`；同时 `updated_at=now`。
- 示例：
```ts
const contentType = file.type || 'image/png'
const now = Date.now()
await d1.createArtwork(userId, title, url, url, { mimeType: contentType, updatedAt: now })
```
> 注：如 `createArtwork` 需要新增可选参数，请在 `d1.ts` 同步扩展。

---

## 任务 D：Feed thumbUrl 优先逻辑

- 文件：`apps/worker-api/src/routers/feed.ts`
- 修改映射：
```ts
thumbUrl: a.thumb_url || a.url,
```

---

## 任务 E：取消点赞时补齐缓存失效

- 文件：`apps/worker-api/src/routers/artworks.ts` DELETE `/artworks/:id/like`
- 在返回前调用：
```ts
await redis.invalidateFeed()
```

---

## 验收
- 运行：
```bash
npm --workspace apps/worker-api run deploy
```
- 验证：
  - 发布后详情 `published_at` 有值；
  - Feed 响应中的每项 `thumbUrl` 为 `thumb_url||url`；
  - 取消点赞后重新进入 Feed，点赞数刷新；
  - 新增迁移在 D1 Studio 可见新增列。
