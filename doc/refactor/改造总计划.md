# AI 社区全流程改造总计划（ClaudeCode 执行版）

> 提示词（务必复制到 PR/对话开头）：
> 你是 ClaudeCode，请严格按照本文件逐项实施。本次仅允许修改目录：`apps/worker-api/**`、`apps/web/**`、`apps/worker-api/migrations/**`、`doc/**`、`README.md`。每完成一小项：
> - 保持现有缩进与格式；
> - 本地构建/部署验证；
> - 在提交信息中勾选本清单对应条目并附带验证截图/日志；
> - 如与现有代码冲突，以本文件为准。

---

## 0. 目标与成果
- 目标：补齐 D1 字段、后端接口与缓存失效；实现“上传→草稿→发布→缩略图→Feed/用户页渲染”闭环；完成用户资料的真实渲染；细化点赞/收藏/取消全链路。
- 成果：
  - 所有新字段在 D1 可见；
  - 新增接口 `/api/users/me` 正常返回；
  - 用户页使用真实数据源（头像/作品/收藏）；
  - 点赞/收藏/取消与发布后，Feed 与用户页列表可正确刷新；
  - README/蓝图字段表更新。

---

## 1. 数据库与后端改造

### 1.1 新增迁移：时间与生成元数据字段
- 新建 `apps/worker-api/migrations/005_extend_fields.sql`：
```sql
-- users 时间戳
ALTER TABLE users ADD COLUMN created_at INTEGER;
ALTER TABLE users ADD COLUMN updated_at INTEGER;

-- artworks 时间戳与生成元数据
ALTER TABLE artworks ADD COLUMN updated_at INTEGER;
ALTER TABLE artworks ADD COLUMN published_at INTEGER;
ALTER TABLE artworks ADD COLUMN prompt TEXT;
ALTER TABLE artworks ADD COLUMN model TEXT;
ALTER TABLE artworks ADD COLUMN seed INTEGER;
ALTER TABLE artworks ADD COLUMN width INTEGER;
ALTER TABLE artworks ADD COLUMN height INTEGER;
ALTER TABLE artworks ADD COLUMN mime_type TEXT;
```
- 执行并验证：
```bash
cd apps/worker-api
wrangler d1 migrations apply test-d1 --remote
```
- D1 Studio 确认新增列。

### 1.2 发布接口写入发布时间与更新时间
- 文件：`apps/worker-api/src/services/d1.ts`
- 在 `publishArtwork` 中写：
```ts
async publishArtwork(id: string) {
  const now = Date.now()
  await this.db.prepare(
    `UPDATE artworks SET status='published', published_at=?, updated_at=? WHERE id=?`
  ).bind(now, now, id).run()
  return this.getArtwork(id)
}
```

### 1.3 上传接口补充文件元信息与更新时间
- 文件：`apps/worker-api/src/routers/artworks.ts`
- 在 `/upload` 中：
```ts
const contentType = file.type || 'image/png'
// 如能读取宽高，则一并写入 width/height
// 将 now 传入 d1.createArtwork 的可选参数 updatedAt/mimeType
```
- 若需扩展 `createArtwork`，在 `d1.ts` 增加可选参数：
```ts
async createArtwork(userId: string, title: string, url: string, thumbUrl?: string,
  opts?: { mimeType?: string; width?: number; height?: number; updatedAt?: number; prompt?: string; model?: string; seed?: number })
```

### 1.4 新增接口：GET /api/users/me（受保护）
- 新建或扩展路由 `apps/worker-api/src/routers/users.ts`：
```ts
router.get('/me', async (c) => {
  const userId = (c as any).get('userId') as string
  if (!userId) return c.json(fail('AUTH_REQUIRED','signin'), 401)
  const d1 = D1Service.fromEnv(c.env)
  // 可直接返回 USERS 基本资料（如需单独查询可在 d1.ts 提供 getUser）
  return c.json(ok({ id: userId }))
})
```
> 说明：鉴权由 `authMiddleware` 负责，已在受保护请求中 Upsert 用户。必要时在 `d1.ts` 新增 `getUser(id)` 返回 name/email/profile_pic/created_at。

### 1.5 Feed 映射 thumbUrl 优先
- 文件：`apps/worker-api/src/routers/feed.ts`
- 将：
```ts
thumbUrl: a.url,
```
- 改为：
```ts
thumbUrl: (a as any).thumb_url || a.url,
```

### 1.6 取消点赞时补齐缓存失效
- 文件：`apps/worker-api/src/routers/artworks.ts`（DELETE /:id/like）
- 在返回前调用：
```ts
await redis.invalidateFeed()
```

### 1.7 Feed 排序改为“发布时间优先”
- 文件：`apps/worker-api/src/services/d1.ts`（`listFeed` 查询）
- 将 `ORDER BY a.created_at DESC` 改为：
```sql
ORDER BY COALESCE(a.published_at, a.created_at) DESC
```
> 目的：用户刚发布的作品能更快出现在推荐列表顶部（与缓存失效配合）。

---

## 2. 前端对接与渲染

### 2.1 用户页改为真实数据源
- 页面：`apps/web/app/user/[username]/page.tsx`
- 替换 `mockUser`：
```ts
const me = await authFetch('/api/users/me')
const [artworks, favorites] = await Promise.all([
  authFetch(API.userArtworks(me.id)),
  authFetch(API.userFavorites(me.id))
])
```
- 头像/昵称使用 USERS（如需更多字段，后端 `getUser` 返回 name/email/profile_pic）。
- 本人视角：展示草稿+发布；他人视角：仅发布（后端已控制）。

### 2.2 操作后刷新（SWR revalidate/mutate）
- 发布成功：
```ts
import { mutate } from 'swr'
mutate(`user-artworks-${me.id}`)
mutate('feed')
```
- 点赞/收藏/取消：乐观更新卡片；完成后根据页面定位执行 `mutate` 或重拉。

### 2.3 卡片/详情统一使用 thumbUrl
- 组件 `ArtworkCard`、详情页图片来源：
```ts
const src = artwork.thumbUrl || artwork.originalUrl
```

### 2.4 错误处理与登录
- 401：触发 Clerk `SignInButton` 或跳转 `/login`
- 500：Toast + 重试（已可复用 `ApiErrorBoundary`）

### 2.5 发布后推荐页“即时可见”保障
- 方案 A（推荐）：发布成功后跳转到 `/feed` 并刷新路由：
```tsx
'use client'
import { useRouter } from 'next/navigation'
const router = useRouter()
// 发布成功回调：
router.push('/feed')
router.refresh()
```
- 方案 B（CSR 列表）：若 Feed 改为 SWR 驱动，发布成功后执行 `mutate('feed')`。
- 说明：后端已失效 `feed:list:*`，并将排序切到 `published_at` 优先，前端只需路由刷新即可看到新作品。

---

## 3. 访问控制与缓存（摘要）

### 3.1 访问控制
- 公共只读：GET /api/feed、/api/artworks/:id、/api/users/:id/artworks|favorites
- 受保护：upload/publish/like/favorite、GET /api/users/me
- 如需收紧：在 `authMiddleware` 去掉公共 GET 放行。

### 3.2 缓存键与失效
- 键：`feed:list:{limit}`、`user:{id}:artworks`、`user:{id}:favorites`、`artwork:{id}:likes`
- 失效：
  - Upload：`user:{me}:artworks`
  - Publish：`user:{me}:artworks`、`feed:list:*`
  - Like/Unlike：`artwork:{id}:likes` 自增/自减 + `feed:list:*`
  - Favorite/Unfavorite：`user:{me}:favorites`、`feed:list:*`
  - Cron 缩略图：`feed:list:*`、`user:{author}:artworks`

---

## 4. 测试与发布

### 4.1 本地
```bash
# 后端
npm --workspace apps/worker-api run dev
# 前端
npm --workspace apps/web run dev
```
- Postman/脚本测试：
```bash
curl -i "$API_BASE/api/health"
curl -i "$API_BASE/api/feed"
# 上传草稿
# 发布/点赞/收藏/取消...
```

### 4.2 构建与部署
```bash
npm --workspace apps/web run build
npm --workspace apps/worker-api run deploy
```

### 4.3 故障排查
- `wrangler tail ai-social-api --format pretty`
- Pages：确认 `nodejs_compat` 与 `NEXT_PUBLIC_API_BASE_URL`
- D1：确认迁移 `--remote` 已应用

---

## 5. 勾选清单（提交时逐项勾选）
- [ ] 005 迁移已应用，D1 新字段可见
- [ ] 发布写 `published_at/updated_at` 生效
- [ ] 上传写 `mime_type/width/height/updated_at`（可选）
- [ ] 新增 GET `/api/users/me` 可用
- [ ] Feed 映射 `thumb_url || url`
- [ ] 取消点赞失效补齐
- [ ] Feed 排序按 `published_at` 优先
- [ ] 用户页用真实数据渲染头像/作品/收藏
- [ ] 发布后跳转/刷新 Feed 即时可见
- [ ] 构建/部署通过，主要页面不再 500

---

## 6. 代码修改范围（再次强调）
- `apps/worker-api/**`：路由、中间件、服务、迁移
- `apps/web/**`：页面、hooks、组件
- `doc/**` 与 `README.md`：仅增改说明

> 提醒：任何与本计划冲突的旧实现，以本计划为准；每一步都要“编辑 → 本地验证 → 发布 → 打勾”。
