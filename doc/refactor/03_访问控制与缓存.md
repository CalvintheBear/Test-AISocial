# 03｜访问控制与缓存（ClaudeCode 任务）

> 提示词：本章仅编辑 `apps/worker-api/src/middlewares/**`、`apps/worker-api/src/routers/**` 与 `doc/**`。

---

## 访问控制策略
- 公共只读（默认放行）：
  - GET /api/feed
  - GET /api/artworks/:id
  - GET /api/users/:id/artworks（他人仅返回已发布）
  - GET /api/users/:id/favorites
- 受保护：
  - POST /api/artworks/upload
  - POST /api/artworks/:id/publish
  - POST/DELETE /api/artworks/:id/like
  - POST/DELETE /api/artworks/:id/favorite
  - GET /api/users/me
- 若需收紧访问：在 `authMiddleware` 去掉公共 GET 放行即可。

---

## 缓存键与失效
- 键：
  - `feed:list:{limit}`
  - `user:{userId}:artworks`
  - `user:{userId}:favorites`
  - `artwork:{id}:likes`
- 写操作失效表：
  - Upload（draft）：`user:{me}:artworks`
  - Publish：`user:{me}:artworks`、`feed:list:*`
  - Like：`artwork:{id}:likes`（自增）+ `feed:list:*`（失效）
  - Unlike：同上（自减）+ `feed:list:*`（失效，务必补齐）
  - Favorite：`user:{me}:favorites`、`feed:list:*`
  - Unfavorite：`user:{me}:favorites`、`feed:list:*`
  - Cron 缩略图：`feed:list:*`、`user:{author}:artworks`

---

## 校验
- 通过 `wrangler tail` 观察写操作后是否立刻触发失效逻辑日志；
- 重新请求 Feed 与用户页，检查 UI 是否更新；
- Redis（Upstash）未配置时走内存回退不报错。
