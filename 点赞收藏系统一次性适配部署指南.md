# AI Socialç‚¹èµæ”¶è—ç³»ç»Ÿä¸€æ¬¡æ€§é€‚é…éƒ¨ç½²æŒ‡å—

## ğŸš€ éƒ¨ç½²ç­–ç•¥ï¼šä¸€æ¬¡æ€§å…¨é‡åˆ‡æ¢

### æ ¸å¿ƒæ€è·¯
æ— éœ€æ¸è¿›å¼è¿ç§»ï¼Œç›´æ¥ä½¿ç”¨æ–°ç³»ç»Ÿæ›¿æ¢æ—§ç³»ç»Ÿï¼Œä¿æŒAPIå…¼å®¹æ€§ï¼Œç¡®ä¿ç”¨æˆ·æ— æ„ŸçŸ¥åˆ‡æ¢ã€‚

## ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡æ£€æŸ¥æ¸…å•

### âœ… å·²å°±ç»ªé¡¹ç›®
- [x] åç«¯APIç«¯ç‚¹ï¼š`/api/artworks/:id/state` å’Œ `/api/artworks/batch/state`
- [x] å‰ç«¯Hookï¼š`useArtworkState`
- [x] æ–°ç»„ä»¶ï¼š`EnhancedLikeButton` å’Œ `EnhancedFavoriteButton`
- [x] ç±»å‹æ£€æŸ¥ï¼šæ— TypeScripté”™è¯¯
- [x] æ„å»ºæµ‹è¯•ï¼šé€šè¿‡ç¼–è¯‘

## ğŸ”§ ä¸€æ¬¡æ€§é€‚é…æ–¹æ¡ˆ

### 1. å…¨å±€æ›¿æ¢ç­–ç•¥

#### 1.1 åˆ›å»ºç»Ÿä¸€çš„ç‰¹æ€§å¼€å…³
```typescript
// lib/featureFlags.ts
export const FEATURE_FLAGS = {
  USE_NEW_LIKE_SYSTEM: true, // ç›´æ¥å¯ç”¨æ–°ç³»ç»Ÿ
}
```

#### 1.2 åˆ›å»ºå…¼å®¹æ€§åŒ…è£…ç»„ä»¶
```typescript
// components/LikeButtonWrapper.tsx
import React from 'react'
import { EnhancedLikeButton } from './EnhancedLikeButton'
import OldLikeButton from './app/LikeButton'

interface LikeButtonWrapperProps {
  artworkId: string
  initialLikeCount?: number
  initialIsLiked?: boolean
  size?: 'sm' | 'md' | 'lg'
  className?: string
  showCount?: boolean
}

export function LikeButtonWrapper({
  artworkId,
  initialLikeCount = 0,
  initialIsLiked = false,
  size = 'md',
  className,
  showCount = true,
}: LikeButtonWrapperProps) {
  // ç›´æ¥ä½¿ç”¨æ–°ç³»ç»Ÿï¼Œå¿½ç•¥æ—§å‚æ•°
  return (
    <EnhancedLikeButton
      artworkId={artworkId}
      initialState={{
        liked: initialIsLiked,
        likeCount: initialLikeCount,
      }}
      className={className}
      showCount={showCount}
    />
  )
}
```

```typescript
// components/FavoriteButtonWrapper.tsx
import React from 'react'
import { EnhancedFavoriteButton } from './EnhancedFavoriteButton'

interface FavoriteButtonWrapperProps {
  artworkId: string
  initialFavCount?: number
  initialIsFaved?: boolean
  className?: string
  showCount?: boolean
}

export function FavoriteButtonWrapper({
  artworkId,
  initialFavCount = 0,
  initialIsFaved = false,
  className,
  showCount = true,
}: FavoriteButtonWrapperProps) {
  return (
    <EnhancedFavoriteButton
      artworkId={artworkId}
      initialState={{
        faved: initialIsFaved,
        favCount: initialFavCount,
      }}
      className={className}
      showCount={showCount}
    />
  )
}
```

### 2. æ‰¹é‡æ›¿æ¢ç°æœ‰ç»„ä»¶

#### 2.1 å…¨å±€æŸ¥æ‰¾å’Œæ›¿æ¢æ˜ å°„
```typescript
// æ›¿æ¢è§„åˆ™ï¼ˆä¸€æ¬¡æ€§æ‰§è¡Œï¼‰

// æ–‡ä»¶ï¼šcomponents/feed/ArtworkCard.tsx
// æ›¿æ¢å‰ï¼š
// <LikeButton artworkId={artwork.id} initialLikeCount={artwork.like_count} initialIsLiked={artwork.user_state.liked} />
// æ›¿æ¢åï¼š
// <LikeButtonWrapper artworkId={artwork.id} initialLikeCount={artwork.like_count} initialIsLiked={artwork.user_state.liked} />

// æ–‡ä»¶ï¼šcomponents/artwork/ArtworkDetail.tsx
// æ›¿æ¢å‰ï¼š
// <LikeButton artworkId={id} ... />
// <FavoriteButton artworkId={id} ... />
// æ›¿æ¢åï¼š
// <LikeButtonWrapper artworkId={id} ... />
// <FavoriteButtonWrapper artworkId={id} ... />
```

#### 2.2 æ‰¹é‡æ›¿æ¢è„šæœ¬
```bash
# ä¸€æ¬¡æ€§æ›¿æ¢å‘½ä»¤
find apps/web/components -name "*.tsx" -exec sed -i '' \
  's/\<LikeButton\([^>]*\)\>/LikeButtonWrapper\1/g' {} \;

find apps/web/components -name "*.tsx" -exec sed -i '' \
  's/\<FavoriteButton\([^>]*\)\>/FavoriteButtonWrapper\1/g' {} \;
```

### 3. æ•°æ®å…¼å®¹æ€§å¤„ç†

#### 3.1 ç°æœ‰æ•°æ®ç»“æ„é€‚é…
```typescript
// lib/dataAdapter.ts
export function adaptArtworkData(oldData: any) {
  return {
    ...oldData,
    // ç¡®ä¿æ–°ç³»ç»Ÿéœ€è¦çš„å­—æ®µå­˜åœ¨
    user_state: {
      liked: oldData.user_state?.liked || false,
      faved: oldData.user_state?.faved || false,
    },
    like_count: oldData.like_count || 0,
    fav_count: oldData.fav_count || 0,
  }
}
```

#### 3.2 APIå“åº”å…¼å®¹æ€§
```typescript
// ä¿æŒæ—§APIå“åº”æ ¼å¼ï¼Œç¡®ä¿å‰ç«¯å…¼å®¹æ€§
{
  "success": true,
  "data": {
    "id": "123",
    "title": "ä½œå“æ ‡é¢˜",
    "like_count": 42,
    "fav_count": 18,
    "user_state": {
      "liked": true,
      "faved": false
    }
    // å…¶ä»–åŸæœ‰å­—æ®µä¿æŒä¸å˜
  }
}
```

## ğŸ”„ ä¸€æ¬¡æ€§éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šå‡†å¤‡éƒ¨ç½²åŒ…ï¼ˆ5åˆ†é’Ÿï¼‰
```bash
# 1. ç¡®ä¿æ‰€æœ‰ä»£ç å·²æäº¤
git add .
git commit -m "feat: ä¸€é”®åˆ‡æ¢åˆ°æ–°ç‚¹èµæ”¶è—ç³»ç»Ÿ"

# 2. æ„å»ºæ£€æŸ¥
npm run build
npm --workspace apps/worker-api run typecheck

# 3. åˆ›å»ºå¤‡ä»½åˆ†æ”¯
git checkout -b old-system-backup
git checkout main
```

### æ­¥éª¤2ï¼šæ‰¹é‡æ›¿æ¢ï¼ˆ10åˆ†é’Ÿï¼‰
```bash
# åˆ›å»ºæ›¿æ¢è„šæœ¬
cat > deploy-replace.sh << 'EOF'
#!/bin/bash

# æ›¿æ¢LikeButton
grep -r "LikeButton" apps/web/components/ --include="*.tsx" | grep -v "Enhanced\|Wrapper"
echo "å‡†å¤‡æ›¿æ¢LikeButtonç»„ä»¶..."

# æ›¿æ¢FavoriteButton  
grep -r "FavoriteButton" apps/web/components/ --include="*.tsx" | grep -v "Enhanced\|Wrapper"
echo "å‡†å¤‡æ›¿æ¢FavoriteButtonç»„ä»¶..."

# æ‰§è¡Œæ›¿æ¢ï¼ˆç¤ºä¾‹ï¼‰
sed -i '' 's/import LikeButton from.*LikeButton/import { LikeButtonWrapper } from "@/components/LikeButtonWrapper"/g' apps/web/components/**/*.tsx
sed -i '' 's/import FavoriteButton from.*FavoriteButton/import { FavoriteButtonWrapper } from "@/components/FavoriteButtonWrapper"/g' apps/web/components/**/*.tsx
EOF

chmod +x deploy-replace.sh
./deploy-replace.sh
```

### æ­¥éª¤3ï¼šéªŒè¯å…³é”®é¡µé¢ï¼ˆ10åˆ†é’Ÿï¼‰
```typescript
// éªŒè¯æ£€æŸ¥æ¸…å•
const deploymentChecklist = {
  feed: {
    path: '/feed',
    components: ['ArtworkCard'],
    checks: ['ç‚¹èµçŠ¶æ€åŒæ­¥', 'æ”¶è—çŠ¶æ€åŒæ­¥', 'æ•°é‡æ˜¾ç¤ºæ­£ç¡®']
  },
  artworkDetail: {
    path: '/artwork/[id]/[slug]',
    components: ['ArtworkDetail'],
    checks: ['è¯¦æƒ…é¡µçŠ¶æ€åŒæ­¥', 'æ“ä½œåé¦ˆæ­£å¸¸']
  },
  userProfile: {
    path: '/user/[username]',
    components: ['UserArtworks'],
    checks: ['ä¸ªäººé¡µé¢çŠ¶æ€ä¸€è‡´']
  }
}
```

### æ­¥éª¤4ï¼šéƒ¨ç½²æ‰§è¡Œï¼ˆ5åˆ†é’Ÿï¼‰
```bash
# åç«¯éƒ¨ç½²
cd apps/worker-api
npm run deploy

# å‰ç«¯éƒ¨ç½²  
cd ../web
npm run build
vercel --prod
```

## ğŸ¯ å¿«é€ŸéªŒè¯æ–¹æ¡ˆ

### éªŒè¯è„šæœ¬
```typescript
// deployment-validation.ts
async function validateDeployment() {
  const testCases = [
    { artworkId: 'test-1', action: 'like' },
    { artworkId: 'test-2', action: 'favorite' },
    { artworkId: 'test-3', action: 'toggle' }
  ]

  for (const testCase of testCases) {
    // 1. æ£€æŸ¥APIå“åº”
    const response = await fetch(`/api/artworks/${testCase.artworkId}/state`)
    const data = await response.json()
    
    console.log(`âœ… ${testCase.artworkId}: çŠ¶æ€è·å–æ­£å¸¸`, data.data)
    
    // 2. æ£€æŸ¥æ“ä½œåŠŸèƒ½
    // å®é™…æµ‹è¯•éœ€è¦ç”¨æˆ·ç™»å½•ï¼Œè¿™é‡ŒåªåšAPIæ£€æŸ¥
  }
}

validateDeployment()
```

## ğŸš¨ å›æ»šæ–¹æ¡ˆ

### ä¸€é”®å›æ»šè„šæœ¬
```bash
#!/bin/bash
# rollback.sh

echo "å¼€å§‹å›æ»š..."

# 1. è¿˜åŸæ—§ç»„ä»¶å¼•ç”¨
git checkout HEAD~1 -- apps/web/components/

# 2. é‡æ–°éƒ¨ç½²
cd apps/worker-api && npm run deploy
cd ../web && npm run build && vercel --prod

echo "å›æ»šå®Œæˆï¼"
```

## ğŸ“Š éƒ¨ç½²åç›‘æ§

### å…³é”®æŒ‡æ ‡ç›‘æ§
```typescript
// ç›‘æ§é…ç½®
const monitoringConfig = {
  metrics: {
    apiResponseTime: '< 500ms',
    errorRate: '< 1%',
    likeOperationSuccess: '> 99%',
    favoriteOperationSuccess: '> 99%'
  },
  alerts: {
    apiError: 'è¿ç»­3æ¬¡å¤±è´¥',
    responseTime: 'è¶…è¿‡2ç§’',
    userComplaints: 'è¶…è¿‡5æ¡'
  }
}
```

## â±ï¸ æ€»éƒ¨ç½²æ—¶é—´é¢„ä¼°

| é˜¶æ®µ | æ—¶é—´ | å¤‡æ³¨ |
|---|---|---|
| å‡†å¤‡æ£€æŸ¥ | 5åˆ†é’Ÿ | æ„å»ºéªŒè¯ |
| ä»£ç æ›¿æ¢ | 10åˆ†é’Ÿ | æ‰¹é‡æ›¿æ¢ |
| éƒ¨ç½²æ‰§è¡Œ | 5åˆ†é’Ÿ | å‰åç«¯éƒ¨ç½² |
| éªŒè¯æµ‹è¯• | 10åˆ†é’Ÿ | åŠŸèƒ½éªŒè¯ |
| **æ€»è®¡** | **30åˆ†é’Ÿ** | ä¸€æ¬¡æ€§å®Œæˆ |

## ğŸ¯ éƒ¨ç½²æˆåŠŸæ ‡å‡†

éƒ¨ç½²å®Œæˆåï¼Œç”¨æˆ·åº”èƒ½ï¼š
1. âœ… ç‚¹èµ/æ”¶è—çŠ¶æ€åœ¨æ‰€æœ‰é¡µé¢ä¿æŒä¸€è‡´
2. âœ… æ•°é‡æ˜¾ç¤ºæ— å›æ»šç°è±¡
3. âœ… æ“ä½œå“åº”æ—¶é—´ < 500ms
4. âœ… é”™è¯¯ç‡ < 1%

**æ— éœ€æ¸è¿›å¼è¿ç§»ï¼Œ30åˆ†é’Ÿå†…å®Œæˆå…¨é‡åˆ‡æ¢ï¼**