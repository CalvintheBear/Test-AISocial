# AI Social点赞收藏系统一次性适配部署指南

## 🚀 部署策略：一次性全量切换

### 核心思路
无需渐进式迁移，直接使用新系统替换旧系统，保持API兼容性，确保用户无感知切换。

## 📋 部署前准备检查清单

### ✅ 已就绪项目
- [x] 后端API端点：`/api/artworks/:id/state` 和 `/api/artworks/batch/state`
- [x] 前端Hook：`useArtworkState`
- [x] 新组件：`EnhancedLikeButton` 和 `EnhancedFavoriteButton`
- [x] 类型检查：无TypeScript错误
- [x] 构建测试：通过编译

## 🔧 一次性适配方案

### 1. 全局替换策略

#### 1.1 创建统一的特性开关
```typescript
// lib/featureFlags.ts
export const FEATURE_FLAGS = {
  USE_NEW_LIKE_SYSTEM: true, // 直接启用新系统
}
```

#### 1.2 创建兼容性包装组件
```typescript
// components/LikeButtonWrapper.tsx
import React from 'react'
import { EnhancedLikeButton } from './EnhancedLikeButton'
import OldLikeButton from './app/LikeButton'

interface LikeButtonWrapperProps {
  artworkId: string
  initialLikeCount?: number
  initialIsLiked?: boolean
  size?: 'sm' | 'md' | 'lg'
  className?: string
  showCount?: boolean
}

export function LikeButtonWrapper({
  artworkId,
  initialLikeCount = 0,
  initialIsLiked = false,
  size = 'md',
  className,
  showCount = true,
}: LikeButtonWrapperProps) {
  // 直接使用新系统，忽略旧参数
  return (
    <EnhancedLikeButton
      artworkId={artworkId}
      initialState={{
        liked: initialIsLiked,
        likeCount: initialLikeCount,
      }}
      className={className}
      showCount={showCount}
    />
  )
}
```

```typescript
// components/FavoriteButtonWrapper.tsx
import React from 'react'
import { EnhancedFavoriteButton } from './EnhancedFavoriteButton'

interface FavoriteButtonWrapperProps {
  artworkId: string
  initialFavCount?: number
  initialIsFaved?: boolean
  className?: string
  showCount?: boolean
}

export function FavoriteButtonWrapper({
  artworkId,
  initialFavCount = 0,
  initialIsFaved = false,
  className,
  showCount = true,
}: FavoriteButtonWrapperProps) {
  return (
    <EnhancedFavoriteButton
      artworkId={artworkId}
      initialState={{
        faved: initialIsFaved,
        favCount: initialFavCount,
      }}
      className={className}
      showCount={showCount}
    />
  )
}
```

### 2. 批量替换现有组件

#### 2.1 全局查找和替换映射
```typescript
// 替换规则（一次性执行）

// 文件：components/feed/ArtworkCard.tsx
// 替换前：
// <LikeButton artworkId={artwork.id} initialLikeCount={artwork.like_count} initialIsLiked={artwork.user_state.liked} />
// 替换后：
// <LikeButtonWrapper artworkId={artwork.id} initialLikeCount={artwork.like_count} initialIsLiked={artwork.user_state.liked} />

// 文件：components/artwork/ArtworkDetail.tsx
// 替换前：
// <LikeButton artworkId={id} ... />
// <FavoriteButton artworkId={id} ... />
// 替换后：
// <LikeButtonWrapper artworkId={id} ... />
// <FavoriteButtonWrapper artworkId={id} ... />
```

#### 2.2 批量替换脚本
```bash
# 一次性替换命令
find apps/web/components -name "*.tsx" -exec sed -i '' \
  's/\<LikeButton\([^>]*\)\>/LikeButtonWrapper\1/g' {} \;

find apps/web/components -name "*.tsx" -exec sed -i '' \
  's/\<FavoriteButton\([^>]*\)\>/FavoriteButtonWrapper\1/g' {} \;
```

### 3. 数据兼容性处理

#### 3.1 现有数据结构适配
```typescript
// lib/dataAdapter.ts
export function adaptArtworkData(oldData: any) {
  return {
    ...oldData,
    // 确保新系统需要的字段存在
    user_state: {
      liked: oldData.user_state?.liked || false,
      faved: oldData.user_state?.faved || false,
    },
    like_count: oldData.like_count || 0,
    fav_count: oldData.fav_count || 0,
  }
}
```

#### 3.2 API响应兼容性
```typescript
// 保持旧API响应格式，确保前端兼容性
{
  "success": true,
  "data": {
    "id": "123",
    "title": "作品标题",
    "like_count": 42,
    "fav_count": 18,
    "user_state": {
      "liked": true,
      "faved": false
    }
    // 其他原有字段保持不变
  }
}
```

## 🔄 一次性部署步骤

### 步骤1：准备部署包（5分钟）
```bash
# 1. 确保所有代码已提交
git add .
git commit -m "feat: 一键切换到新点赞收藏系统"

# 2. 构建检查
npm run build
npm --workspace apps/worker-api run typecheck

# 3. 创建备份分支
git checkout -b old-system-backup
git checkout main
```

### 步骤2：批量替换（10分钟）
```bash
# 创建替换脚本
cat > deploy-replace.sh << 'EOF'
#!/bin/bash

# 替换LikeButton
grep -r "LikeButton" apps/web/components/ --include="*.tsx" | grep -v "Enhanced\|Wrapper"
echo "准备替换LikeButton组件..."

# 替换FavoriteButton  
grep -r "FavoriteButton" apps/web/components/ --include="*.tsx" | grep -v "Enhanced\|Wrapper"
echo "准备替换FavoriteButton组件..."

# 执行替换（示例）
sed -i '' 's/import LikeButton from.*LikeButton/import { LikeButtonWrapper } from "@/components/LikeButtonWrapper"/g' apps/web/components/**/*.tsx
sed -i '' 's/import FavoriteButton from.*FavoriteButton/import { FavoriteButtonWrapper } from "@/components/FavoriteButtonWrapper"/g' apps/web/components/**/*.tsx
EOF

chmod +x deploy-replace.sh
./deploy-replace.sh
```

### 步骤3：验证关键页面（10分钟）
```typescript
// 验证检查清单
const deploymentChecklist = {
  feed: {
    path: '/feed',
    components: ['ArtworkCard'],
    checks: ['点赞状态同步', '收藏状态同步', '数量显示正确']
  },
  artworkDetail: {
    path: '/artwork/[id]/[slug]',
    components: ['ArtworkDetail'],
    checks: ['详情页状态同步', '操作反馈正常']
  },
  userProfile: {
    path: '/user/[username]',
    components: ['UserArtworks'],
    checks: ['个人页面状态一致']
  }
}
```

### 步骤4：部署执行（5分钟）
```bash
# 后端部署
cd apps/worker-api
npm run deploy

# 前端部署  
cd ../web
npm run build
vercel --prod
```

## 🎯 快速验证方案

### 验证脚本
```typescript
// deployment-validation.ts
async function validateDeployment() {
  const testCases = [
    { artworkId: 'test-1', action: 'like' },
    { artworkId: 'test-2', action: 'favorite' },
    { artworkId: 'test-3', action: 'toggle' }
  ]

  for (const testCase of testCases) {
    // 1. 检查API响应
    const response = await fetch(`/api/artworks/${testCase.artworkId}/state`)
    const data = await response.json()
    
    console.log(`✅ ${testCase.artworkId}: 状态获取正常`, data.data)
    
    // 2. 检查操作功能
    // 实际测试需要用户登录，这里只做API检查
  }
}

validateDeployment()
```

## 🚨 回滚方案

### 一键回滚脚本
```bash
#!/bin/bash
# rollback.sh

echo "开始回滚..."

# 1. 还原旧组件引用
git checkout HEAD~1 -- apps/web/components/

# 2. 重新部署
cd apps/worker-api && npm run deploy
cd ../web && npm run build && vercel --prod

echo "回滚完成！"
```

## 📊 部署后监控

### 关键指标监控
```typescript
// 监控配置
const monitoringConfig = {
  metrics: {
    apiResponseTime: '< 500ms',
    errorRate: '< 1%',
    likeOperationSuccess: '> 99%',
    favoriteOperationSuccess: '> 99%'
  },
  alerts: {
    apiError: '连续3次失败',
    responseTime: '超过2秒',
    userComplaints: '超过5条'
  }
}
```

## ⏱️ 总部署时间预估

| 阶段 | 时间 | 备注 |
|---|---|---|
| 准备检查 | 5分钟 | 构建验证 |
| 代码替换 | 10分钟 | 批量替换 |
| 部署执行 | 5分钟 | 前后端部署 |
| 验证测试 | 10分钟 | 功能验证 |
| **总计** | **30分钟** | 一次性完成 |

## 🎯 部署成功标准

部署完成后，用户应能：
1. ✅ 点赞/收藏状态在所有页面保持一致
2. ✅ 数量显示无回滚现象
3. ✅ 操作响应时间 < 500ms
4. ✅ 错误率 < 1%

**无需渐进式迁移，30分钟内完成全量切换！**